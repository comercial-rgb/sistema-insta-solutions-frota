<% if (@current_user.id == @user.id) && !@user.client? %>
    <%= simple_form_for @user, url: update_access_data_path(id: @user.id), html: {id: 'change-data-'+@user.id.to_s}, method: :post, validate: false do |f| %>
        
        <div class="row">
            <!-- Título -->
            <div class="col-12">
                <h5 class="mt-4"><%= User.human_attribute_name(:access_data).upcase %></h5>
            </div>

            <!-- Senha de acesso -->
            <div class="col-12 col-md-3 mb-3">
                <%= f.input :current_password, input_html: {autocomplete: 'new-password'}  %>
            </div>
            <%= render 'users/forms/access_data_fields', f: f %>
        </div>
        
        <%= render 'common_pages/save', f: f, return_path: (@current_user.id != @user.id) ? change_data_path : nil %>
    <% end %>
<% end %>

<% if @current_user.admin? && @current_user.id != @user.id && @user.provider? %>
    <div class="row">
        <div class="col-12">
            <h5 class="mt-4"><%= User.human_attribute_name(:password_management).upcase %></h5>
        </div>
        <div class="col-12 col-md-6">
            <div class="card border-warning">
                <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-key-fill text-warning"></i> Resetar Senha</h6>
                    <p class="card-text">Clique no botão abaixo para gerar uma nova senha temporária para este fornecedor.</p>
                    <button type="button" class="btn btn-warning" id="reset-password-btn" data-user-id="<%= @user.id %>">
                        <i class="bi bi-arrow-clockwise"></i> Gerar Nova Senha
                    </button>
                    <div id="password-display" class="mt-3" style="display:none;">
                        <div class="alert alert-success">
                            <strong>Nova senha gerada com sucesso!</strong><br>
                            Senha temporária: <strong id="temp-password" class="fs-5"></strong>
                            <button type="button" class="btn btn-sm btn-outline-success ms-2" onclick="navigator.clipboard.writeText(document.getElementById('temp-password').textContent)">
                                <i class="bi bi-clipboard"></i> Copiar
                            </button>
                        </div>
                        <p class="text-muted small">
                            <i class="bi bi-info-circle"></i> Copie e envie a senha manualmente ao fornecedor.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const resetBtn = document.getElementById('reset-password-btn');
            if (resetBtn) {
                resetBtn.addEventListener('click', function() {
                    if (!confirm('Tem certeza que deseja resetar a senha deste fornecedor?')) {
                        return;
                    }
                    
                    const userId = this.dataset.userId;
                    this.disabled = true;
                    this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Gerando...';
                    
                    fetch(`/reset_user_password/${userId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.result) {
                            document.getElementById('temp-password').textContent = data.password;
                            document.getElementById('password-display').style.display = 'block';
                            this.innerHTML = '<i class="bi bi-check-circle"></i> Senha Gerada';
                            setTimeout(() => {
                                this.disabled = false;
                                this.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Gerar Nova Senha';
                            }, 3000);
                        } else {
                            alert('Erro ao resetar senha: ' + data.errors);
                            this.disabled = false;
                            this.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Gerar Nova Senha';
                        }
                    })
                    .catch(error => {
                        alert('Erro ao resetar senha');
                        this.disabled = false;
                        this.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Gerar Nova Senha';
                    });
                });
            }
        });
    </script>
<% end %>

<%
# End of file _change_data.html.erb
# Path: ./app/views/users/forms/_change_data.html.erb
%>
