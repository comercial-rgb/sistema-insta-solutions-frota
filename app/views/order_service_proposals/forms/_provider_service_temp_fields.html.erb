<%= provider_service_temp.input :id, as: :hidden %>
<%= provider_service_temp.input :name, as: :hidden %>
<%= provider_service_temp.input :description, as: :hidden %>

<div class="card mb-2 shadow-sm border-success">
  <div class="card-body py-2 px-3">
    <div class="row g-2 align-items-end">
      
      <!-- Bot√£o para remover este item (apenas se pode adicionar/remover itens) -->
      <% if defined?(can_add_items) && can_add_items %>
        <div class="col-12 text-end">
          <button type="button" class="btn btn-sm btn-outline-danger remove-provider-service-temp" 
            title="Remover item">
            <i class="bi bi-trash"></i> Remover
          </button>
        </div>
      <% end %>

      <%= provider_service_temp.input :service_id, as: :hidden %>
      <%= provider_service_temp.input :category_id, as: :hidden, input_html: {
        value: provider_service_temp.object.category_id,
        class: 'change-category-type-provider-service-temp',
        id: "change-category-type-provider-service-temp-#{position}"
      } %>

      <div class="col-md-12">
        <%= provider_service_temp.input :name, label: part_service_name, disabled: true, input_html: {value: provider_service_temp.object.getting_name_and_description, class: 'form-control form-control-sm text-success fw-bold' } %>
      </div>

      <%# Busca interativa no Cat√°logo de Pe√ßas ‚Äî s√≥ para pe√ßas (category_id == 1) %>
      <% if provider_service_temp.object.category_id == Category::SERVICOS_PECAS_ID %>
        <%
          # Busca refer√™ncia pr√©-carregada
          ref_value = provider_service_temp.object.referencia_catalogo.presence
          if ref_value.blank? && defined?(@catalogo_referencias) && @catalogo_referencias.present?
            peca_nome = provider_service_temp.object.service&.name || provider_service_temp.object.name
            if peca_nome.present?
              ref_value = @catalogo_referencias[peca_nome]
              if ref_value.blank?
                peca_norm = peca_nome.to_s.strip.downcase
                @catalogo_referencias.each do |grupo, refs|
                  if grupo.downcase.include?(peca_norm) || peca_norm.include?(grupo.downcase)
                    ref_value = refs
                    break
                  end
                end
              end
            end
          end
          peca_nome_busca = provider_service_temp.object.service&.name || provider_service_temp.object.name
        %>

        <div class="col-md-12 catalogo-search-section" data-peca-nome="<%= peca_nome_busca %>">
          <% if ref_value.present? %>
            <div class="catalogo-ref-display">
              <label class="form-label form-label-sm text-muted mb-0">
                <i class="bi bi-bookmark-fill text-primary"></i> Ref. Cat√°logo
              </label>
              <div class="form-control form-control-sm bg-light text-primary fw-semibold d-flex justify-content-between align-items-center" style="font-size: 0.8rem; min-height: auto; padding: 4px 8px;">
                <span class="catalogo-ref-text"><%= ref_value %></span>
                <button type="button" class="btn btn-sm btn-link p-0 ms-2 catalogo-search-btn" title="Buscar mais op√ß√µes no cat√°logo">
                  <i class="bi bi-search"></i>
                </button>
              </div>
            </div>
          <% else %>
            <button type="button" class="btn btn-sm btn-outline-primary catalogo-search-btn w-100 mb-1" title="Buscar refer√™ncias no cat√°logo de pe√ßas">
              <i class="bi bi-search me-1"></i> Buscar no Cat√°logo
            </button>
          <% end %>
          <%= provider_service_temp.input :referencia_catalogo, as: :hidden, input_html: { value: ref_value, class: 'catalogo-ref-hidden' } %>

          <%# Painel de resultados do cat√°logo (oculto por padr√£o) %>
          <div class="catalogo-results-panel d-none mt-1">
            <div class="card border-primary">
              <div class="card-header bg-primary bg-opacity-10 py-1 px-2 d-flex justify-content-between align-items-center">
                <small class="fw-bold text-primary"><i class="bi bi-book me-1"></i> Cat√°logo de Pe√ßas</small>
                <button type="button" class="btn-close btn-close-sm catalogo-close-btn" aria-label="Fechar"></button>
              </div>
              <div class="card-body p-2">
                <div class="input-group input-group-sm mb-2">
                  <input type="text" class="form-control catalogo-search-input" placeholder="Buscar pe√ßa..." value="<%= peca_nome_busca %>">
                  <button type="button" class="btn btn-primary catalogo-do-search-btn"><i class="bi bi-search"></i></button>
                </div>
                <div class="catalogo-results-list" style="max-height: 200px; overflow-y: auto; font-size: 0.8rem;">
                  <p class="text-muted text-center py-2 mb-0">Clique em buscar para consultar o cat√°logo</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <% if provider_service_temp.object.category_id == Category::SERVICOS_PECAS_ID %>
        <div class="col-md-3">
          <%= provider_service_temp.input :brand, input_html: { class: 'form-control form-control-sm' } %>
        </div>
      <% end %>

      <div class="col-md-2">
        <%= provider_service_temp.input :warranty_period, input_html: { class: 'form-control form-control-sm' } %>
      </div>

      <div class="col-md-2">
        <% 
          # Buscar valor m√°ximo permitido do grupo de servi√ßos (para Requisi√ß√£o)
          max_value = defined?(service_max_values) && service_max_values.present? ? service_max_values[provider_service_temp.object.service_id] : nil
        %>
        <%= provider_service_temp.input :price, as: :string, input_html: { 
          class: 'form-control form-control-sm money provider_service_temp_price', 
          value: CustomHelper.to_currency(provider_service_temp.object.price), 
          type: "tel",
          data: max_value.present? ? { max_value: max_value } : {}
        } %>
        <% if max_value.present? %>
          <small class="text-muted">M√°x: <%= number_to_currency(max_value, unit: "R$ ", separator: ",", delimiter: ".") %></small>
        <% end %>
      </div>

      <div class="col-md-1">
        <% 
          # üîí CORRE√á√ÉO BUG REAVALIA√á√ÉO: L√≥gica de bloqueio da quantidade
          # - Cota√ß√µes: sempre bloqueado (quantidade vem da OS)
          # - Requisi√ß√£o: sempre bloqueado (quantidade vem da OS)
          # - Diagn√≥stico original: edit√°vel na cria√ß√£o, bloqueado ap√≥s salvar
          # - Diagn√≥stico enviado para cota√ß√£o (outros fornecedores): sempre bloqueado
          
          if (defined?(is_cotacoes) && is_cotacoes) || (defined?(is_requisicao) && is_requisicao)
            # Cota√ß√µes ou Requisi√ß√£o: quantidade definida na OS, fornecedor n√£o pode editar
            quantity_readonly = true
          elsif defined?(is_diagnostico) && is_diagnostico
            # Para Diagn√≥stico: verifica se √© fornecedor secund√°rio (can_add_items = false)
            # Se can_add_items = false, significa que √© fornecedor secund√°rio e n√£o pode editar
            # Se can_add_items = true, pode editar apenas se a proposta ainda n√£o foi salva
            if defined?(can_add_items) && !can_add_items
              # Fornecedor secund√°rio: n√£o pode editar quantidade
              quantity_readonly = true
            else
              # Fornecedor original: define na cria√ß√£o, depois fica bloqueado
              quantity_readonly = defined?(proposal_persisted) && proposal_persisted
            end
          else
            # Fallback: bloqueia se j√° tem quantidade definida na OS
            quantity_readonly = defined?(os_quantities) && os_quantities.present? && os_quantities[provider_service_temp.object.service_id].present?
          end
        %>
        <% if quantity_readonly %>
          <%= provider_service_temp.input :quantity, disabled: true, input_html: {
            min: 1,
            step: 1,
            inputmode: 'numeric',
            class: 'form-control form-control-sm provider_service_temp_quantity only-read bg-light'
          } %>
          <%= provider_service_temp.hidden_field :quantity, value: provider_service_temp.object.quantity, id: nil %>
        <% else %>
          <%= provider_service_temp.input :quantity, input_html: {
            min: 1,
            step: 1,
            inputmode: 'numeric',
            class: 'form-control form-control-sm provider_service_temp_quantity'
          } %>
        <% end %>
      </div>

      <%  data = Service.getting_values_with_discount_new_product(f.object.order_service.client_id, CustomHelper.to_currency(provider_service_temp.object.price), provider_service_temp.object.quantity.to_i) %>
      <div class="col-md-2">
        <%= provider_service_temp.input :discount_temp, input_html: {value: data[:discount_formatted], class: 'form-control form-control-sm only-read bg-light' } %>
        <%= provider_service_temp.input :discount, as: :hidden, input_html: {value: data[:discount], class: "order_service_proposal_item_discount_#{category_id == Category::SERVICOS_PECAS_ID ? 'part' : 'service'}" } %>
      </div>

      <div class="col-md-2">
        <%= provider_service_temp.input :total_temp, input_html: {value: data[:value_formatted], class: 'form-control form-control-sm only-read fw-bold text-success' } %>
        <%= provider_service_temp.input :total_value, as: :hidden, input_html: {value: data[:value], class: "order_service_proposal_item_total_value_#{category_id == Category::SERVICOS_PECAS_ID ? 'part' : 'service'}" } %>
      </div>

    </div>
  </div>
</div>
