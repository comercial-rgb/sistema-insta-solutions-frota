<!-- Modal -->
<div class="modal fade order-service-proposal-modal" id="approve_order_service_proposal_<%=order_service_proposal.id%>" tabindex="-1">

    <div class="modal-dialog modal-dialog-scrollable" role="document">
        <div class="modal-content">

            <!-- Cabeçalho -->
            <div class="modal-header">

                <!-- Título -->
                <h5 class="modal-title" id="approve_order_service_proposal_label_<%=order_service_proposal.id%>">
                    <small class="text-muted"><%= order_service_proposal.code %></small>
                </h5>

                <!-- Botão fechar -->
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <% justification_triggers = order_service_proposal.approval_justification_triggers %>
                <% justification_required = justification_triggers.any? %>
                <%= form_tag approve_order_service_proposal_path(id: order_service_proposal.id), method: :post, class: 'form-order-service-proposal-to-validate' do |f| %>
                    <% if justification_required %>
                        <div class="alert alert-warning">
                            <p class="mb-2">Foi identificado item repetido nos últimos 30 dias ou ainda em garantia. Informe uma justificativa para seguir com a aprovação.</p>
                            <ul class="mb-0 ps-3">
                                <% justification_triggers.each do |trigger| %>
                                    <li>
                                        <strong><%= trigger[:service_name] || 'Serviço' %></strong>
                                        <% if trigger[:within_30_days] %>
                                            (repetido em <%= l(trigger[:last_date]) %>)
                                        <% end %>
                                        <% if trigger[:within_warranty] && trigger[:warranty_expires_at].present? %>
                                            (garantia até <%= l(trigger[:warranty_expires_at]) %>)
                                        <% end %>
                                    </li>
                                <% end %>
                            </ul>
                        </div>
                    <% end %>
                    <div class="mb-3">
                        <label class="form-label"><%= OrderServiceProposal.human_attribute_name(:reason_approved) %></label>
                        <%= text_area_tag :reason_approved, '', class: 'form-control', id: 'reason_approved_'+order_service_proposal.id.to_s, autofocus: true, autocomplete: 'off', required: justification_required %>
                    </div>
                    <div class="mt-3 text-end">
                        <button class="btn btn-primary btn-sm" type="submit" data-confirm="<%= t('model.confirm_action') %>"><%= t('model.send') %></button>
                    </div>
                <% end %>
            </div>

        </div>
    </div>
</div>
