<%
    current_disabled = defined?(disabled) ? disabled : false
    # Na edição, bloquear todos exceto: centro de custo, categoria e número do empenho
    is_editing = @commitment.persisted?
    edit_blocked = is_editing && !current_disabled
%>
<%= simple_form_for(@commitment) do |f| %>

    <div class="row">
        <div class="col-12">
            <%= f.error_notification %>
            <%= f.error_notification message: f.object.errors[:base].to_sentence if f.object.errors[:base].present? %>
        </div>
    </div>

    <div class="row" >
        <% if @current_user.admin? %>
            <div class="col-12 col-md-3">
                <% if is_editing %>
                    <%= f.association :client, disabled: true, collection: [f.object.client], label_method: :fantasy_name, as: :select, include_blank: false %>
                <% else %>
                    <%= f.association :client, collection: User.client.order(:fantasy_name), label_method: :fantasy_name, as: :select, include_blank: t('model.select_option') %>
                <% end %>
            </div>
        <% else %>
            <%= render 'users/renders/client_selection', f: f, disabled: edit_blocked %>
        <% end %>

        <div class="col-12 col-md-3">
            <% 
              # Obtém os centros de custo disponíveis
              available_cost_centers = CostCenter.getting_by_client_id(@current_user, f.object.client_id)
              
              # Obtém os IDs selecionados (novos da tabela de relacionamento ou legado)
              selected_cost_center_ids = if f.object.cost_centers.any?
                f.object.cost_centers.pluck(:id)
              elsif f.object.cost_center_id.present?
                [f.object.cost_center_id]
              else
                []
              end
            %>
            <%= f.input :cost_center_ids, 
                disabled: current_disabled, 
                collection: available_cost_centers, 
                label_method: :get_text_name, 
                value_method: :id,
                input_html: { multiple: true, class: 'select2', data: { placeholder: t('model.select_option') } },
                selected: selected_cost_center_ids,
                label: CostCenter.model_name.human(count: 2),
                include_blank: false %>
        </div>

        <div class="col-12 col-md-3">
            <%= f.association :sub_unit, disabled: (current_disabled || edit_blocked), collection: SubUnit.getting_data_by_user(@current_user, f.object.client_id), as: :select, include_blank: t('model.select_option') %>
        </div>
        <div class="col-12 col-md-3">
            <%= f.input :commitment_number, disabled: current_disabled %>
        </div>
    </div>

    <div class="row">
        <div class="col-12 col-md-4">
            <%= f.association :contract, disabled: (current_disabled || edit_blocked), collection: Contract.getting_by_client_id(@current_user, f.object.client_id), label_method: :get_formatted_name_with_disponible_value, as: :select, include_blank: t('model.select_option') %>
        </div>
        <div class="col-12 col-md-3">
            <%= f.input :commitment_value, disabled: (current_disabled || edit_blocked), input_html: {class: 'money', value: CustomHelper.to_currency(f.object.commitment_value), type: "tel"}, as: :string %>
        </div>
        <div class="col-12 col-md-3">
            <%= f.association :category, disabled: current_disabled, collection: Category.where(id: [Category::SERVICOS_PECAS_ID, Category::SERVICOS_SERVICOS_ID]), as: :select, include_blank: 'Global (Peças e Serviços)' %>
        </div>
    </div>

    <% if is_editing && !current_disabled %>
        <div class="row mt-3">
            <div class="col-12">
                <div class="alert alert-info" role="alert">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Atenção:</strong> Na edição de empenhos, apenas o <strong>Centro de Custo</strong>, <strong>Categoria</strong> e <strong>N° do Empenho</strong> podem ser alterados.
                </div>
            </div>
        </div>
    <% end %>

    <% if !current_disabled %>
        <%= render 'common_pages/save', f: f, return_path: commitments_path %>
    <% end %>

<% end %>
