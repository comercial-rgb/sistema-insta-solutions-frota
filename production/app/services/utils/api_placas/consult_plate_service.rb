# services/utils/api_placas/consult_plate_service.rb
require 'net/http'
require 'uri'
require 'json'

module Utils
  module ApiPlacas
    class ConsultPlateService
      API_BASE_URL = 'https://wdapi2.com.br/consulta'

      def initialize(plate)
        @plate = plate.to_s.upcase.gsub(/[^A-Z0-9]/, '') # Remove tudo que não for letra ou número
        @token = select_token
      end

      def call
        return nil if @plate.blank? || @token.blank?

        uri = URI("#{API_BASE_URL}/#{@plate}/#{@token}")

        verify_mode = Rails.env.production? ? OpenSSL::SSL::VERIFY_PEER : OpenSSL::SSL::VERIFY_NONE

        if Rails.env.production?
          response = Net::HTTP.start(uri.host, uri.port, use_ssl: true, verify_mode: verify_mode) do |http|
            http.get(uri)
          end

          if response.is_a?(Net::HTTPSuccess)
            JSON.parse(response.body)
          else
            Rails.logger.warn("API Placas erro: #{response.code} - #{response.body}")
            nil
          end
        else
          JSON.parse('{"MARCA":"FIAT","MODELO":"UNO MILLE WAY ECON","SUBMODELO":"UNO","VERSAO":"ECON","ano":"2012","anoModelo":"2013","chassi":"46997","codigoSituacao":"0","cor":"Cinza","data":"09/06/2025 20:02:36","extra":{"ano_fabricacao":"2012","ano_modelo":"2013","caixa_cambio":"","cap_maxima_tracao":"164","carroceria":"72489214","chassi":"9BD15844AD6746997","cilindradas":"1000","combustivel":"Alcool / Gasolina","di":"0","eixo_traseiro_dif":"","eixos":"0","especie":"Passageiro","faturado":"00836942000457","grupo":"UNO","limite_restricao_trib":"","linha":"50111525","media_preco":"1349.0","modelo":"FIAT/UNO MILLE WAY ECON","motor":"","municipio":"ITAJUBA","nacionalidade":"Nacional","peso_bruto_total":"124","placa":"OMA3397","placa_modelo_antigo":"OMA3397","placa_modelo_novo":"OMA3D97","quantidade_passageiro":"5","registro_di":"","renavam":"","restricao_1":"SEM RESTRICAO","restricao_2":"SEM RESTRICAO","restricao_3":"SEM RESTRICAO","restricao_4":"SEM RESTRICAO","s.especie":"Passageiro","segmento":"Auto","situacao_chassi":"N","situacao_veiculo":"S","sub_segmento":"AU - ENTRADA","terceiro_eixo":"","tipo_carroceria":"NAO APLICAVEL","tipo_doc_faturado":"Juridica","tipo_doc_importadora":"Outros","tipo_doc_prop":"Fisica","tipo_montagem":"1","tipo_veiculo":"Automovel","uf":"MG","uf_faturado":"MG","uf_placa":"MG","unidade_local_srf":"0000000"},"fipe":{"dados":[{"ano_modelo":"2013","codigo_fipe":"001366-8","codigo_marca":21,"codigo_modelo":"5664","combustivel":"Gasolina","id_valor":1470511,"mes_referencia":"junho de 2025","referencia_fipe":322,"score":48,"sigla_combustivel":"G","texto_marca":"Fiat","texto_modelo":"UNO ECONOMY 1.4 EVO Fire Flex 8V 2p","texto_valor":"R$ 27.159,00","tipo_modelo":1},{"ano_modelo":"2013","codigo_fipe":"001367-6","codigo_marca":21,"codigo_modelo":"5665","combustivel":"Gasolina","id_valor":1470513,"mes_referencia":"junho de 2025","referencia_fipe":322,"score":48,"sigla_combustivel":"G","texto_marca":"Fiat","texto_modelo":"UNO ECONOMY 1.4 EVO Fire Flex 8V 4p","texto_valor":"R$ 32.172,00","tipo_modelo":1},{"ano_modelo":"2013","codigo_fipe":"001161-4","codigo_marca":21,"codigo_modelo":"644","combustivel":"Gasolina","id_valor":1470569,"mes_referencia":"junho de 2025","referencia_fipe":322,"score":55,"sigla_combustivel":"G","texto_marca":"Fiat","texto_modelo":"Uno Mille 1.0 Fire/ F.Flex/ ECONOMY 2p","texto_valor":"R$ 23.677,00","tipo_modelo":1},{"ano_modelo":"2013","codigo_fipe":"001162-2","codigo_marca":21,"codigo_modelo":"645","combustivel":"Gasolina","id_valor":1470581,"mes_referencia":"junho de 2025","referencia_fipe":322,"score":55,"sigla_combustivel":"G","texto_marca":"Fiat","texto_modelo":"Uno Mille 1.0 Fire/ F.Flex/ ECONOMY 4p","texto_valor":"R$ 28.179,00","tipo_modelo":1},{"ano_modelo":"2013","codigo_fipe":"001264-5","codigo_marca":21,"codigo_modelo":"4763","combustivel":"Gasolina","id_valor":1470593,"mes_referencia":"junho de 2025","referencia_fipe":322,"score":78,"sigla_combustivel":"G","texto_marca":"Fiat","texto_modelo":"Uno Mille Celeb. WAY ECON. 1.0 F.Flex 2p","texto_valor":"R$ 24.689,00","tipo_modelo":1},{"ano_modelo":"2013","codigo_fipe":"001265-3","codigo_marca":21,"codigo_modelo":"4764","combustivel":"Gasolina","id_valor":1470598,"mes_referencia":"junho de 2025","referencia_fipe":322,"score":78,"sigla_combustivel":"G","texto_marca":"Fiat","texto_modelo":"Uno Mille Celeb. WAY ECON. 1.0 F.Flex 4p","texto_valor":"R$ 30.524,00","tipo_modelo":1},{"ano_modelo":"2013","codigo_fipe":"001245-9","codigo_marca":21,"codigo_modelo":"4316","combustivel":"Gasolina","id_valor":1470603,"mes_referencia":"junho de 2025","referencia_fipe":322,"score":55,"sigla_combustivel":"G","texto_marca":"Fiat","texto_modelo":"Uno Mille Celeb/Celeb.ECON 1.0 F.Flex 2p","texto_valor":"R$ 23.505,00","tipo_modelo":1},{"ano_modelo":"2013","codigo_fipe":"001246-7","codigo_marca":21,"codigo_modelo":"4317","combustivel":"Gasolina","id_valor":1470609,"mes_referencia":"junho de 2025","referencia_fipe":322,"score":55,"sigla_combustivel":"G","texto_marca":"Fiat","texto_modelo":"Uno Mille Celeb/Celeb.ECON 1.0 F.Flex 4p","texto_valor":"R$ 30.154,00","tipo_modelo":1},{"ano_modelo":"2013","codigo_fipe":"001415-0","codigo_marca":21,"codigo_modelo":"6692","combustivel":"Gasolina","id_valor":1470612,"mes_referencia":"junho de 2025","referencia_fipe":322,"score":65,"sigla_combustivel":"G","texto_marca":"Fiat","texto_modelo":"Uno Mille Grazie 1.0 Fire Flex 8v 4p","texto_valor":"R$ 38.953,00","tipo_modelo":1},{"ano_modelo":"2013","codigo_fipe":"001393-5","codigo_marca":21,"codigo_modelo":"6320","combustivel":"Gasolina","id_valor":1470619,"mes_referencia":"junho de 2025","referencia_fipe":322,"score":82,"sigla_combustivel":"G","texto_marca":"Fiat","texto_modelo":"UNO MILLE WAY ECO.XINGU 1.0 F.Flex 8v 5p","texto_valor":"R$ 31.449,00","tipo_modelo":1},{"ano_modelo":"2013","codigo_fipe":"001262-9","codigo_marca":21,"codigo_modelo":"4765","combustivel":"Gasolina","id_valor":1470624,"mes_referencia":"junho de 2025","referencia_fipe":322,"score":82,"sigla_combustivel":"G","texto_marca":"Fiat","texto_modelo":"Uno Mille WAY ECONOMY 1.0 F.Flex 2p","texto_valor":"R$ 24.237,00","tipo_modelo":1},{"ano_modelo":"2013","codigo_fipe":"001263-7","codigo_marca":21,"codigo_modelo":"4766","combustivel":"Gasolina","id_valor":1470629,"mes_referencia":"junho de 2025","referencia_fipe":322,"score":82,"sigla_combustivel":"G","texto_marca":"Fiat","texto_modelo":"Uno Mille WAY ECONOMY 1.0 F.Flex 4p","texto_valor":"R$ 29.126,00","tipo_modelo":1},{"ano_modelo":"2013","codigo_fipe":"001343-9","codigo_marca":21,"codigo_modelo":"5483","combustivel":"Gasolina","id_valor":1470681,"mes_referencia":"junho de 2025","referencia_fipe":322,"score":48,"sigla_combustivel":"G","texto_marca":"Fiat","texto_modelo":"UNO VIVACE 1.0 EVO Fire Flex 8V 3p","texto_valor":"R$ 25.639,00","tipo_modelo":1},{"ano_modelo":"2013","codigo_fipe":"001303-0","codigo_marca":21,"codigo_modelo":"5241","combustivel":"Gasolina","id_valor":1470700,"mes_referencia":"junho de 2025","referencia_fipe":322,"score":48,"sigla_combustivel":"G","texto_marca":"Fiat","texto_modelo":"UNO VIVACE/RUA 1.0 EVO Fire Flex 8V 5p","texto_valor":"R$ 31.537,00","tipo_modelo":1},{"ano_modelo":"2013","codigo_fipe":"001345-5","codigo_marca":21,"codigo_modelo":"5485","combustivel":"Gasolina","id_valor":1470705,"mes_referencia":"junho de 2025","referencia_fipe":322,"score":55,"sigla_combustivel":"G","texto_marca":"Fiat","texto_modelo":"UNO WAY 1.0 EVO Fire Flex 8V 2p","texto_valor":"R$ 24.142,00","tipo_modelo":1},{"ano_modelo":"2013","codigo_fipe":"001305-6","codigo_marca":21,"codigo_modelo":"5243","combustivel":"Gasolina","id_valor":1470707,"mes_referencia":"junho de 2025","referencia_fipe":322,"score":55,"sigla_combustivel":"G","texto_marca":"Fiat","texto_modelo":"UNO WAY 1.0 EVO Fire Flex 8V 5p","texto_valor":"R$ 32.750,00","tipo_modelo":1},{"ano_modelo":"2013","codigo_fipe":"001349-8","codigo_marca":21,"codigo_modelo":"5486","combustivel":"Gasolina","id_valor":1470723,"mes_referencia":"junho de 2025","referencia_fipe":322,"score":55,"sigla_combustivel":"G","texto_marca":"Fiat","texto_modelo":"UNO WAY 1.4 EVO Fire Flex 8V 2p","texto_valor":"R$ 33.302,00","tipo_modelo":1},{"ano_modelo":"2013","codigo_fipe":"001306-4","codigo_marca":21,"codigo_modelo":"5244","combustivel":"Gasolina","id_valor":1470726,"mes_referencia":"junho de 2025","referencia_fipe":322,"score":55,"sigla_combustivel":"G","texto_marca":"Fiat","texto_modelo":"UNO WAY 1.4 EVO Fire Flex 8V 5p","texto_valor":"R$ 34.368,00","tipo_modelo":1},{"ano_modelo":"2013","codigo_fipe":"001309-9","codigo_marca":21,"codigo_modelo":"5245","combustivel":"Gasolina","id_valor":1470732,"mes_referencia":"junho de 2025","referencia_fipe":322,"score":55,"sigla_combustivel":"G","texto_marca":"Fiat","texto_modelo":"UNO WAY Celeb. 1.0 EVO Fire Flex 8V 5p","texto_valor":"R$ 30.616,00","tipo_modelo":1},{"ano_modelo":"2013","codigo_fipe":"001310-2","codigo_marca":21,"codigo_modelo":"5246","combustivel":"Gasolina","id_valor":1470739,"mes_referencia":"junho de 2025","referencia_fipe":322,"score":55,"sigla_combustivel":"G","texto_marca":"Fiat","texto_modelo":"UNO WAY Celeb. 1.4 EVO Fire Flex 8V 5p","texto_valor":"R$ 34.428,00","tipo_modelo":1},{"ano_modelo":"2013","codigo_fipe":"001394-3","codigo_marca":21,"codigo_modelo":"6322","combustivel":"Gasolina","id_valor":1470745,"mes_referencia":"junho de 2025","referencia_fipe":322,"score":49,"sigla_combustivel":"G","texto_marca":"Fiat","texto_modelo":"UNO WAY XINGU 1.0 EVO F.Flex 8V 5P","texto_valor":"R$ 32.130,00","tipo_modelo":1},{"ano_modelo":"2013","codigo_fipe":"001395-1","codigo_marca":21,"codigo_modelo":"6323","combustivel":"Gasolina","id_valor":1470747,"mes_referencia":"junho de 2025","referencia_fipe":322,"score":49,"sigla_combustivel":"G","texto_marca":"Fiat","texto_modelo":"UNO WAY XINGU 1.4 EVO F.Flex 8V 5p","texto_valor":"R$ 31.647,00","tipo_modelo":1}]},"listamodelo":["UNO","MILLE","WAY","ECON"],"logo":"https://apiplacas.com.br/logos/logosMarcas/fiat.png","marca":"FIAT","marcaModelo":"FIAT/UNO MILLE WAY ECON","mensagemRetorno":"Sem erros.","modelo":"UNO MILLE WAY ECON","municipio":"PIRANGUINHO","origem":"NACIONAL","placa":"OMA3397","placa_alternativa":"OMA3D97","segmento":"Auto","situacao":"Sem restri\u00e7\u00e3o","sub_segmento":"AU - ENTRADA","uf":"MG"}')
        end

      rescue => e
        Rails.logger.error("Erro na consulta de placa: #{e.message}")
        nil
      end

      private

      def select_token
        Rails.env.production? ? ENV['API_PLACAS_TOKEN_PRODUCTION'] : ENV['API_PLACAS_TOKEN_DEVELOPMENT']
      end
    end
  end
end
