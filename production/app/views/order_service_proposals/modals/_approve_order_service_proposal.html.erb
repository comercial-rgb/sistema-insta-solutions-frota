<!-- Modal -->
<div class="modal fade order-service-proposal-modal" id="approve_order_service_proposal_<%=order_service_proposal.id%>" tabindex="-1">

    <div class="modal-dialog modal-dialog-scrollable" role="document">
        <div class="modal-content">

            <!-- Cabeçalho -->
            <div class="modal-header">

                <!-- Título -->
                <h5 class="modal-title" id="approve_order_service_proposal_label_<%=order_service_proposal.id%>">
                    <small class="text-muted"><%= order_service_proposal.code %></small>
                </h5>

                <!-- Botão fechar -->
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <% justification_triggers = order_service_proposal.approval_justification_triggers %>
                <% justification_required = justification_triggers.any? %>
                <%= form_tag approve_order_service_proposal_path(id: order_service_proposal.id), method: :post, class: 'form-order-service-proposal-to-validate' do |f| %>
                    <% if justification_required %>
                        <div class="alert alert-warning">
                            <p class="mb-2"><i class="bi bi-exclamation-triangle"></i> Foram identificados itens com preços acima da tabela de referência. Informe uma justificativa para seguir com a aprovação:</p>
                            <ul class="mb-0 ps-3">
                                <% justification_triggers.each do |trigger| %>
                                    <li>
                                        <strong><%= trigger[:service_name] || 'Peça' %></strong>
                                        — Preço +<%= trigger[:percentage] %>% acima do permitido
                                        <br>
                                        <small class="text-muted">
                                            Ref. Cilia: <%= CustomHelper.to_currency(trigger[:reference_price]) %> |
                                            Máx. permitido: <%= CustomHelper.to_currency(trigger[:max_allowed]) %> |
                                            Preço atual: <%= CustomHelper.to_currency(trigger[:current_price]) %>
                                        </small>
                                    </li>
                                <% end %>
                            </ul>
                        </div>
                    <% end %>
                    <div class="mb-3">
                        <label class="form-label">
                            <%= OrderServiceProposal.human_attribute_name(:reason_approved) %>
                            <% if justification_required %>
                                <span class="text-danger">*</span>
                            <% end %>
                        </label>
                        <%= text_area_tag :reason_approved, '', 
                            class: 'form-control', 
                            id: 'reason_approved_'+order_service_proposal.id.to_s, 
                            rows: 4,
                            autofocus: true, 
                            autocomplete: 'off', 
                            required: justification_required,
                            placeholder: justification_required ? 
                                "Exemplos de justificativas:\n• Peça original de fábrica com qualidade superior\n• Única opção disponível no mercado no momento\n• Especificação técnica diferenciada exigida pelo fabricante\n• Fornecedor com melhor prazo de entrega em situação emergencial" : 
                                "Observações sobre a aprovação (opcional)" %>
                        <% if justification_required %>
                            <small class="form-text text-muted">
                                <i class="bi bi-info-circle"></i> 
                                Explique o motivo para aprovar itens com preços acima da tabela de referência
                            </small>
                        <% end %>
                    </div>
                    <div class="mt-3 text-end">
                        <button class="btn btn-primary btn-sm" type="submit" data-confirm="<%= t('model.confirm_action') %>"><%= t('model.send') %></button>
                    </div>
                <% end %>
            </div>

        </div>
    </div>
</div>
